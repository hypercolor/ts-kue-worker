{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap","webpack:///./index.ts","webpack:///./src/kue-worker-submitter.ts","webpack:///./src/kue-worker.ts","webpack:///./src/task-router.ts","webpack:///./src/task.ts","webpack:///external \"kue\""],"names":[],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse {\n\t\tvar a = factory();\n\t\tfor(var i in a) (typeof exports === 'object' ? exports : root)[i] = a[i];\n\t}\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading wasm modules\n \tvar installedWasmModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// object with all compiled WebAssembly.Modules\n \t__webpack_require__.w = {};\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export {KueWorker, IKueWorkerConfig, KueWorkerFailedTaskCallback, KueWorkerSuccessfulTaskCallback} from './src/kue-worker';\nexport {Task} from './src/task';\nexport {KueWorkerSubmitter} from './src/kue-worker-submitter';","import * as express from 'express'\nimport * as kue from 'kue'\nimport { IKueWorkerConfig } from './kue-worker'\nimport { ITaskClass } from './task'\n\nexport class KueWorkerSubmitter {\n  constructor(private config: IKueWorkerConfig) {}\n\n  public getBrowserApp(): express.Application {\n    // create a queue to force kue to set its global app variable to use our connection params :/\n    kue.createQueue(this.config.connection)\n\n    return kue.app\n  }\n\n  public registerTasksForSubmitting(taskTypes: Array<ITaskClass>) {\n    taskTypes.forEach(taskType => {\n      this.registerTaskForSubmitting(taskType)\n    })\n    return this\n  }\n\n  public registerTaskForSubmitting(taskType: ITaskClass) {\n    taskType.workerConfig = this.config\n    return this\n  }\n}\n","import * as kue from 'kue'\nimport { Queue } from 'kue'\nimport { ITaskClass, Task } from './task'\nimport { TaskRouter } from './task-router'\n\nexport interface IKueWorkerConfig {\n  connection: {\n    redis: string\n  }\n}\n\nexport type KueWorkerSuccessfulTaskCallback = (task: Task, result: any) => void;\nexport type KueWorkerFailedTaskCallback = (task: Task, error: any) => void;\n\nexport class KueWorker {\n  public jobQueue: Queue\n\n  constructor(public config: IKueWorkerConfig) {\n    this.jobQueue = kue.createQueue(config.connection)\n\n    this.jobQueue.watchStuckJobs(1000 * 10)\n\n    // this.jobQueue.on('ready', function(){\n    //   console.info('Queue is ready!');\n    // });\n\n    this.jobQueue.on('error', function(err: Error) {\n      console.error('KueWorker: There was an error in the main queue!')\n      console.error(err)\n      console.error(err.stack)\n    })\n  }\n\n  public registerTasksForProcessing(taskTypes: Array<ITaskClass>, successCallback: KueWorkerSuccessfulTaskCallback, failCallback: KueWorkerFailedTaskCallback) {\n    taskTypes.forEach(taskType => {\n      this.registerTaskForProcessing(taskType, successCallback, failCallback)\n    })\n  }\n\n  public registerTaskForProcessing(taskType: ITaskClass, successCallback: KueWorkerSuccessfulTaskCallback, failCallback: KueWorkerFailedTaskCallback) {\n    TaskRouter.registerTask(taskType)\n\n    taskType.workerConfig = this.config\n\n    this.jobQueue.process(taskType.name, taskType.maxConcurrent, (job: kue.Job, done: kue.DoneCallback) => {\n      const start = new Date().getTime()\n\n      let task: Task\n\n      TaskRouter.deserializeTask(job)\n        .then(t => {\n          task = t\n          return task.doTaskWork()\n        })\n        .then(result => {\n          if (result && result.error) {\n            console.log('Job ' + task.constructor.name + ' (' + job.id + ') error: ' + JSON.stringify(result.error))\n            job.remove()\n            done(result.error)\n          } else {\n            let msg = task.constructor.name + '[' + job.id + '] ' + (new Date().getTime() - start) + ' ms'\n\n            if (result && result.message) {\n              msg += ': ' + result.message\n            }\n            console.log(msg)\n            job.remove()\n            successCallback(task, result)\n            done()\n          }\n        })\n        .catch(err => {\n          console.log('Job ' + task.constructor.name + ' (' + job.id + ') error: ', err)\n          job.remove()\n          failCallback(task, err)\n          done(err)\n        })\n    })\n  }\n}\n","import * as kue from 'kue'\nimport { ITaskClass, Task } from './task'\n\nexport class TaskRouter {\n  private static taskTypes: Array<ITaskClass> = []\n\n  public static registerTask(taskType: ITaskClass) {\n    this.taskTypes.push(taskType)\n  }\n\n  public static deserializeTask(job: kue.Job): Promise<Task> {\n    if (job.type) {\n      for (const taskType of this.taskTypes) {\n        if (job.type === taskType.name) {\n          return taskType.deserialize(job.data)\n        }\n      }\n    }\n\n    return Promise.reject(new Error('Couldnt match task type: ' + job.type))\n  }\n}\n","import { Job } from 'kue'\nimport * as kue from 'kue'\nimport { IKueWorkerConfig } from './kue-worker'\n\nexport interface ITaskClass {\n  name: string\n  maxConcurrent: number\n  workerConfig: IKueWorkerConfig\n  deserialize(serializedParams: any): Promise<Task>\n}\n\nexport abstract class Task {\n  static maxConcurrent = 1\n\n  static workerConfig: IKueWorkerConfig\n\n  protected job?: Job\n\n  public abstract serialize(): any\n\n  public abstract doTaskWork(): Promise<any>\n\n  public submit() {\n    const config = (this.constructor as any).workerConfig\n    if (!config) {\n      return Promise.reject(\n        new Error(\n          'Worker config not set for task ' + this.constructor.name + ', was it registered with a KueWorkerSubmitter?'\n        )\n      )\n    } else {\n      return new Promise((resolve, reject) => {\n        const job = kue\n          .createQueue(config.connection)\n          .create(this.constructor.name, this.serialize())\n          .priority('normal')\n          .attempts(1)\n          .backoff(true)\n          .removeOnComplete(false)\n          .delay(0)\n          .save((err: Error) => {\n            if (err) {\n              console.log('Error submitting task: ' + JSON.stringify(err))\n              reject(err)\n            } else {\n              resolve(job)\n            }\n          })\n      })\n    }\n  }\n}\n","module.exports = require(\"kue\");"],"sourceRoot":""}
{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap","webpack:///./index.ts","webpack:///./src/task-router.ts","webpack:///./src/task.ts","webpack:///./src/worker.ts","webpack:///external \"kue\""],"names":[],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse {\n\t\tvar a = factory();\n\t\tfor(var i in a) (typeof exports === 'object' ? exports : root)[i] = a[i];\n\t}\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading wasm modules\n \tvar installedWasmModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// object with all compiled WebAssembly.Modules\n \t__webpack_require__.w = {};\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","\nexport {Worker} from './src/worker';\nexport {Task} from './src/task';","import * as kue from 'kue';\nimport {ITaskType, Task} from './task';\n\nexport class TaskRouter {\n\n  private static taskTypes: Array<ITaskType<any>> = [];\n\n  public static registerTask(taskType: ITaskType<any>) {\n    this.taskTypes.push(taskType);\n  }\n\n  public static deserializeTask(job: kue.Job): Task | null {\n\n    let task: Task | null = null;\n\n    if (job.type) {\n\n      for (const taskType of this.taskTypes) {\n        if (job.type === taskType.name) {\n\n          task = new taskType(job.data);\n          break;\n\n        }\n      }\n\n    }\n\n    return task;\n\n  }\n\n}\n","import * as kue from 'kue';\nimport {Job} from 'kue';\n\n// export interface ITaskParams {\n//   [key: string]: any;\n// }\n\n// TODO: CONVERT THIS TO CONFIG\nconst redisConfig = {\n  redis: process.env.REDIS_URL\n};\n\nexport interface ITaskResult {\n  success: boolean;\n  error?: any;\n  result: any;\n}\n\nexport interface ITaskType<T extends Task> {\n  name: string;\n  new(params: any): T;\n}\n\nexport abstract class Task {\n\n  public valid = false;\n\n  protected job?: Job;\n\n  public abstract get maxConcurrent(): number;\n\n  public abstract workerRun(): Promise<ITaskResult>;\n\n  protected abstract get params(): any;\n\n\n\n  public submit() {\n\n    if (this.valid){\n\n      // console.log('Submitting valid task: ' + JSON.stringify(task.serialize()));\n\n      // console.log('Connecting to redis with config: ' + JSON.stringify(redisConfig));\n      const jobQueue = kue.createQueue(redisConfig);\n\n      return new Promise((resolve, reject) => {\n\n        // this.sharedInstance.jobQueue = kue.createQueue();\n        const job = jobQueue.create(this.constructor.name, this.serialize())\n        .priority('normal')\n        .attempts(1)\n        .backoff(true)\n        .removeOnComplete(false)\n        .delay(0)\n        .save((err: Error) => {\n          if (err){\n            console.log('Error submitting task: ' + JSON.stringify(err));\n            reject(err);\n          } else {\n            // console.log('Task submitted.');\n            resolve(job);\n          }\n        });\n\n      });\n\n    } else {\n      console.log('Warning, tried to submit an invalid task: ' + JSON.stringify(this));\n      return Promise.reject({code: 500, error: 'Invalid task: ' + JSON.stringify(this)});\n    }\n\n  }\n\n\n  public serialize() {\n    const json = this.params;\n    json.type = this.constructor.name;\n    return json;\n  }\n}\n","\n\nimport * as express from 'express'\nimport * as kue from 'kue'\nimport {Queue} from 'kue';\nimport { ITaskType } from \"./task\";\nimport {TaskRouter} from './task-router';\n\nconst redisConfig = {\n  redis: process.env.REDIS_URL\n};\n\n\n\nexport class Worker {\n\n  // private static sharedInstance: Worker = new Worker();\n\n  public jobQueue: Queue;\n\n  constructor() {\n\n    // console.log('Setting up Kue...');\n\n    this.jobQueue = kue.createQueue(redisConfig);\n\n    this.jobQueue.watchStuckJobs(1000 * 10);\n\n    // this.jobQueue.on('ready', function(){\n    //   console.info('Queue is ready!');\n    // });\n\n    this.jobQueue.on('error', function(err: Error){\n      console.error('There was an error in the main queue!');\n      console.error(err);\n      console.error(err.stack);\n    });\n\n  }\n\n  public static launchBrowser(expressApp: express.Application){\n\n\n    expressApp.use('/kue', kue.app);\n\n\n  }\n\n\n\n  public registerTask(taskType: ITaskType<any>){\n\n    TaskRouter.registerTask(taskType);\n\n    this.jobQueue.process(taskType.name, new taskType({}).maxConcurrent, (job: kue.Job, done: kue.DoneCallback) => {\n\n      const task = TaskRouter.deserializeTask(job);\n      const start = new Date().getTime();\n\n      if (task){\n\n        // console.log('Deserialized task: ' + JSON.stringify(task.serialize()) + ' from job: ' + JSON.stringify(job));\n\n        task.workerRun()\n        .then(result => {\n          if (result.error){\n            console.log('Job ' + task.constructor.name + ' (' + job.id + ') error: ' + JSON.stringify(result.error));\n            job.remove();\n            done(result.error);\n          } else {\n            console.log('Processed job ' + task.constructor.name + ' (' + job.id + ') in ' + (new Date().getTime() - start) + ' ms.');\n            job.remove();\n            done();\n          }\n        })\n        .catch(err => {\n\n          console.log('Job ' + task.constructor.name + ' (' + job.id + ') error: ', err);\n          job.remove();\n          done(err);\n        });\n\n      } else {\n        console.log('Warning, couldn\\'t deserialize task: ' + JSON.stringify(job));\n        job.remove();\n        done(new Error('Couldn\\'t deserialize task.'));\n      }\n\n    });\n\n  }\n\n\n}\n","module.exports = require(\"kue\");"],"sourceRoot":""}